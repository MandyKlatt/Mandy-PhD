---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
)
```

```{r}
library(needs)
needs(ltm,
      xtable,
      broom,
      ppcor,
      jtools,
      lm.beta,
      janitor,
      lubridate,
      readxl,
      ggthemes,
      gridExtra,
      imputeTS,
      DescTools,
      cowplot,
      rstatix,
      ggpubr,
      lme4,
      lmerTest,
      viridis,
      gridExtra,
      gridtext,
      magrittr,
      PerformanceAnalytics,
      Hmisc,
      corrplot,
      tidyverse,
      ggplot2,
      apaTables)


# disruption & confidence rating
df_rating <- 
  excel_sheets("data/Coding_SRI.xlsx") %>% 
  map_df(~read_xlsx("data/Coding_SRI.xlsx",.)) %>% # read in data with two sheets
  dplyr::select(ID, # select relevant columns 
         "disruption_factor", # -99 = subject did not notice event; -100 = experimenter did not asked for event
         "confidence_factor",
         "event"
         ) %>% 
  mutate(disruption_factor = ifelse(disruption_factor < 0,
                                    yes = NA,
                                    no = disruption_factor
                                    ),
         confidence_factor = ifelse(confidence_factor < 0,
                                   yes = NA,
                                   no = confidence_factor),
         event = as_factor(event)
         )

# demographic data
df_demo <- 
  read_excel("./data/data_empschul_labor_lehrperson.xlsx") %>% # read in excel 
  transmute(ID = LI06_05, # select and rename relevant columns 
            gender = factor(LI02_01_1,
                            levels = 1:2,
                            labels = c("male","female")
                            ),
            age = LI03_01, # 1 = male; 2 = female
            teaching_experience = LI04_01)

# merge two data frames by ID 
df_merge <- merge(df_demo,
                  df_rating,
                  by = "ID") %>% 
  filter(!ID %in% c("126", # exclude cases with no fitbit data (to check see data Heart Rate)
                    "132")
         )

# rm(list = c("df_demo","df_rating"))


data_path <- "./data/heart_rate_data"

main <-
map(.x = dir(path = data_path,
             pattern = ".csv"),
    ~ read_csv(file.path(data_path, .), 
               id = "id",
               col_types = c("t","n")
               ) %>% 
  mutate(time = .$Time - min(.$Time),
         time = as.numeric(time),
         heart_rate = `Heart Rate`,
         ID = id,
         time_span = case_when(str_detect(string = id, pattern = "_a") ~ "end",
                               str_detect(string = id, pattern = "_m") ~ "teaching",
                               str_detect(string = id, pattern = "_p") ~ "preparation",
                               str_detect(string = id, pattern = "_s") ~ "post",
                               str_detect(string = id, pattern = "_i") ~ "interview",
                               TRUE ~ "overall"
                               ),
         ID = str_extract(string = ID,
                          pattern = "[:digit:]{3}"),
         ID = as.numeric(ID)
      ) %>%
      # filter(time <= 600) %>% # filter for 10min intervals
    filter(time <= 7200) %>% # filter for 2 hours (maximal duration of study)
    dplyr::select(!c("Time","Heart Rate","id"))
    ) %>%
  bind_rows()

main <-
  left_join(main, df_merge,
            by = "ID")

main <- 
  main %>% 
  dplyr::select("time", "heart_rate", "ID", "time_span") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  dplyr::summarize(mean_heart = mean(heart_rate),
            sd_heart = sd(heart_rate)) %>%
  ungroup() %>% 
  right_join(x = .,
             y = main,
             by = "ID") %>% 
  mutate(heart_rate_std = (heart_rate - mean_heart)/
           sd_heart) %>% 
  filter(!(time_span == "teaching" & time > 600)) 

```

# Graph

```{r fig.width = 10,results='hide',fig.keep='all'}
loess_plot_overall <-
  main %>% 
  filter(time_span == "overall") %>%
  dplyr::select("ID","time_span", "time","heart_rate_std") %>% 
  distinct() %>% 
  ggplot(mapping = aes(x = time,
                       y = heart_rate_std
                       )
         ) +
  # geom_point(alpha = 0.05) + 
  geom_smooth(se = FALSE,
              size = 0.5,
              colour = "black") +
  scale_color_viridis_d(option = "A",
                        end = 0.8) +
  scale_linetype_manual(values = c(1, 6)) +
  scale_x_continuous(expand = c(0, NA),
                     breaks = seq(0, 9000, 600)) +
  scale_y_continuous(breaks = seq(-1, 1, 0.5)) + 
  labs(x = "Time (in Seconds)",
       y = "") +
  ggtitle("Overall Course of Average Heartrate") +
  theme_apa() + 
  theme(axis.title.y = element_blank())

lm_plot_phases <-
  main %>% 
  filter(time_span != "overall") %>%
  dplyr::select("ID","time_span", "time","heart_rate_std") %>% 
  mutate(time_span = factor(time_span,
                            levels = c("preparation","teaching","post","interview","end"),
                            labels = c("(1) Pre-teaching\nphase","(2) Teaching\nphase","(3) Post-teaching\nphase","(4) Interview\nphase","(5) End\nphase"))) %>% 
  distinct() %>% 
  ggplot(mapping = aes(x = time,
                       y = heart_rate_std
                       )
         ) +
  # geom_point(alpha = 0.05) + 
  geom_smooth(method = "lm",
              se = TRUE,
              size = 0.5,
              colour = "black") +
  scale_color_viridis_d(option = "A",
                        end = 0.8) +
  scale_linetype_manual(values = c(1, 6)) +
  # scale_x_continuous(expand = c(0, NA),
  #                    breaks = seq(0, 9000, 600)) +
  #scale_y_continuous(breaks = seq(0, 160, 5)) + 
  labs(x = "Time (in Seconds)",
       y = "",
       subtitle = "") +
  theme_apa() +
  theme(axis.title.y = element_blank()) +
  facet_grid(cols = vars(time_span),
             scales = "free_x")

ggsave(filename = "plots_publication/lm_plot.png",
       width = 22,
       height = 12,
       units = "cm")


ki_plot_phases <-
  main %>% 
  filter(time_span != "overall") %>%
  dplyr::select("ID","time_span", "time","heart_rate_std") %>% 
  mutate(time_span = factor(time_span,
                            levels = c("preparation","teaching","post","interview","end"),
                            labels = c("(1) Pre-teaching phase","(2) Teaching phase","(3) Post-teaching phase","(4) Interview phase","(5) End phase"))) %>% 
  distinct() %>%
  group_by(time_span) %>% 
  summarise(z_mean = mean(heart_rate_std),
            z_sd = sd(heart_rate_std),
            z_t = qt(p = 0.01 / 2,      # 0.01 KI
               df = n() - 1,
               lower.tail = F
               ),
            z_error = z_sd / sqrt(n()),
            lower = z_mean - z_t * z_error,
            upper = z_mean + z_t * z_error,
            ) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = factor(0),
                       y = z_mean)) + 
  geom_point() +
  geom_errorbar(mapping = aes(ymin = lower,
                              ymax = upper),
                width = 0.2) +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  labs(subtitle = "1% Confidence Intervall",
       x = "") +
  facet_grid(cols = vars(time_span)) +
  theme_apa() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.title.y = element_blank())


text_y <- text_grob("Average Heart Rate (Standardized)",
                   rot = 90)

plot_overall <-
  grid.arrange(loess_plot_overall, lm_plot_phases, ki_plot_phases,
               ncol = 1,
               left = text_y
               )

plot_overall



lm_plot <-
  main %>%
  filter(time_span != "overall") %>%
  dplyr::select("ID","time_span", "time","heart_rate_std") %>%
  mutate(time_span = factor(time_span,
                            levels = c("preparation","teaching","post","interview","end"),
                            labels = c("(1) Pre Teaching\nPhase","(2) Teaching\nPhase","(3) Post Teaching\nPhase","(4) Interview\nPhase","(5) End\nPhase")
                            ),
         time = time / 60
         ) %>%
  distinct() %>%
  ggplot(mapping = aes(x = time,
                       y = heart_rate_std
                       )
         ) +
  # geom_point(alpha = 0.05) +
  geom_smooth(method = "lm",
              se = T,
              size = 0.5,
              colour = "black",
              level = 0.99) +
  scale_color_viridis_d(option = "A",
                        end = 0.8) +
  #scale_linetype_manual(values = c(1, 6)) +
  scale_x_continuous(breaks = seq(0, 10, 2)) +
  #scale_y_continuous(breaks = seq(0, 160, 5)) +
  labs(x = "Time (in Minutes)",
       y = "Average Standardized Heart Rate",
       caption = expression(paste(italic("Note: "),
                                  "The shadow around the line represents the 99% confidence interval."
                                  )
                            )
       ) +
  theme_apa() +
  theme(plot.subtitle = element_text(face = "italic"),
        plot.caption = element_text(hjust = 0)) +
  facet_grid(cols = vars(time_span),
             scales = "free_x")
ggsave(filename = "plots_publication/lm_plot.png",
       plot = lm_plot,
       width = 20,
       height = 12,
       units = "cm")

```

# Slopes and Intercepts

```{r}
df_regression <- 
  main %>% 
  filter(time_span != "overall") %>%
  dplyr::select("ID", "time_span","time","heart_rate_std","heart_rate") %>% 
  distinct() %>% 
  mutate(time = time / 60) %>% 
  mutate(ID = as_factor(ID),
         Phase = factor(time_span,
                           levels = c("preparation","teaching","post","interview","end"),
                            labels = c("Pre Teaching Phase","Teaching Phase","Post Teaching Phase","Interview Phase","End Phase")
                           )
         )

fix_models <-
  df_regression %>%
  split(.$Phase) %>%
  map( ~ lm(formula = heart_rate_std ~ 0 + ID + time:ID,
            data = .)) %>%
  map(
    ~ coef(.) %>%
      tibble::as_tibble(.,
                        rownames = "name") %>%
      transmute(
        type = if_else(str_detect(name,
                                  ":"),
                       true = "slope",
                       false = "intercept"),
        id = str_remove_all(name,
                            "[^[:digit:]]"),
        value = value
      ),
    
  ) %>%
  bind_rows(.id = "Phase") %>%
  pivot_wider(names_from = type,
              values_from = value)

p.values_slope <-
  fix_models %>%
  split(.$Phase) %>%
  map( ~ t.test(x = .$slope,
                mu = 0)$p.value) %>%
  bind_rows(.id = "Phase") %>%
  pivot_longer(cols = everything(),
               names_to = "Phase",
               values_to = "p.value_slope")

p.values_intercept <-
  fix_models %>%
  split(.$Phase) %>%
  map( ~ t.test(x = .$intercept,
                mu = 0)$p.value) %>%
  bind_rows(.id = "Phase") %>%
  pivot_longer(cols = everything(),
               names_to = "Phase",
               values_to = "p.value_intercept")

sd_mean <-
  fix_models %>%
  group_by(Phase) %>%
  dplyr::summarize(
    mean_slope = mean(slope),
    sd_slope = sd(slope),
    mean_intercept = mean(intercept),
    sd_intercept = sd(intercept)
  )

table_data <- 
  right_join(x = sd_mean,
             y = p.values_intercept,
             by = "Phase") %>% 
  right_join(x = .,
             y = p.values_slope,
             by = "Phase") %>% 
  transmute(Phase = factor(Phase,
                           levels = c("Pre Teaching Phase","Teaching Phase","Post Teaching Phase","Interview Phase","End Phase")
                           ),
            n = NA,
            `Mean(Intercept)` = round(mean_intercept, digits = 3),
            `SD(Intercept)` = round(sd_intercept, digits = 3),
            `p-Value (Intercept)` = p.value_intercept,
            `Mean(Slope)` = round(mean_slope, digits = 3), 
            `SD(Slope)` = round(sd_slope,digits = 3),
            `p-Value (Slope)` = p.value_slope, 
            ) %>% 
  arrange(Phase)

table_data$n[table_data$Phase == "Pre Teaching Phase"] <- df_regression %>% filter(Phase == "Pre Teaching Phase") %>% pull(heart_rate_std) %>% length()
table_data$n[table_data$Phase == "Teaching Phase"] <- df_regression %>% filter(Phase == "Teaching Phase") %>% pull(heart_rate_std) %>% length()
table_data$n[table_data$Phase == "Post Teaching Phase"] <- df_regression %>% filter(Phase == "Post Teaching Phase") %>% pull(heart_rate_std) %>% length()
table_data$n[table_data$Phase == "Interview Phase"] <- df_regression %>% filter(Phase == "Interview Phase") %>% pull(heart_rate_std) %>% length()
table_data$n[table_data$Phase == "End Phase"] <- df_regression %>% filter(Phase == "End Phase") %>% pull(heart_rate_std) %>% length()

table_data %>% 
  knitr::kable(.)
```

# Plots for all phases

```{r}
mods <-   
  df_regression %>% 
  split(.$time_span) %>% 
  map(~ lm(formula = heart_rate_std ~ 0 + ID + time:ID,
       data = .
       )
      )

graph_data <- 
  df_regression %>% 
  split(.$time_span) 

example <- list(mod = mods$preparation, data = graph_data$preparation)


list(`Preparation Phase` = list(name = "Preparation Phase", mod = mods$preparation, data = graph_data$preparation),
     `Teaching Phase` = list(name = "Teaching Phase", mod = mods$teaching, data = graph_data$teaching),
     `Post Teaching Phase` = list(name = "Post Teaching Phase",mod = mods$post, data = graph_data$post),
     `Interview Phase` = list(name = "Interview Phase",mod = mods$interview, data = graph_data$interview),
     `End Phase` = list(name = "End Phase",mod = mods$end, data = graph_data$end)
     ) %>% 
  map(~ ggplot(data = .$data,
               mapping = aes(x = time,
                             y = heart_rate_std,
                             group = ID)) +
        geom_line(mapping = aes(y = fitted(.$mod)),
                  color = "blue",
                  size = 1) +
        geom_point(alpha = 0.5,
                   size = 0.5) +
        labs(title = .$name,
             y = "Heart Rate (Standardized)",
             x = "Time (in Seconds)") +
        facet_wrap( ~ ID, nrow = 6) +
        theme_apa()
      )
```


# t-Tests 
## using heart rate means

```{r}
df_ttest <- 
  df_regression %>% 
  group_by(ID, time_span) %>% 
  summarize(mean_heart_rate = mean(heart_rate_std)) %>% 
  ungroup()
```

## Teaching vs. Pre-Teaching (mean HR)

```{r}
df_ttest %$% 
  t.test(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "preparation"],
         paired = T)

df_ttest %$% 
  CohenD(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "preparation"],
         pooled = T)
```

## Teaching vs. Post-Teaching (mean HR)

```{r}
df_ttest %$% 
  t.test(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "post"],
         paired = T)

df_ttest %$% 
  CohenD(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "post"],
         pooled = T)
```


## Teaching vs. Interview (mean HR)

```{r}
df_ttest %$% 
  t.test(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "interview"],
         paired = T)

df_ttest %$% 
  CohenD(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "interview"],
         pooled = T)
```

## Teaching vs. End (mean HR)

```{r}
df_ttest %$% 
  t.test(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "end"],
         paired = T)

df_ttest %$% 
  CohenD(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "end"],
         pooled = T)
```

# t-Tests 
## using mean Slope 

```{r}
df_ttest_slope <- 
  fix_models %>% 
  group_by(id, Phase) %>% 
  summarize(mean_slope = mean(slope)) %>% 
  ungroup()
```


## Teaching vs. Interview

```{r}
df_ttest_slope %$% 
  t.test(x = .$mean_slope[.$Phase == "Teaching Phase"],
         y = .$mean_slope[.$Phase == "Interview Phase"],
         paired = T)

df_ttest_slope %$% 
  CohenD(x = .$mean_slope[.$Phase == "Teaching Phase"],
         y = .$mean_slope[.$Phase == "Interview Phase"],
         pooled = T)
```

## Teaching vs. End

```{r}
df_ttest_slope %$% 
  t.test(x = .$mean_slope[.$Phase == "Teaching Phase"],
         y = .$mean_slope[.$Phase == "End Phase"],
         paired = T)

df_ttest_slope %$% 
  CohenD(x = .$mean_slope[.$Phase == "Teaching Phase"],
         y = .$mean_slope[.$Phase == "End Phase"],
         pooled = T)
```

## Interview vs. End

```{r}
df_ttest_slope %$% 
  t.test(x = .$mean_slope[.$Phase == "Interview Phase"],
         y = .$mean_slope[.$Phase == "End Phase"],
         paired = T)

df_ttest_slope %$% 
  CohenD(x = .$mean_slope[.$Phase == "Interview Phase"],
         y = .$mean_slope[.$Phase == "End Phase"],
         pooled = T)
```

### Correlation 

## Pr-teaching phase

```{r}
main %>% 
  filter(time_span == "preparation") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_pre
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```

## Teaching phase

```{r}
main %>% 
  filter(time_span == "teaching") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_teaching
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```


## Post-teaching phase

```{r}
main %>% 
  filter(time_span == "post") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_post
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```

## Interview phase

```{r}
main %>% 
  filter(time_span == "interview") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_interview
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```

## End phase

```{r}
main %>% 
  filter(time_span == "end") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_end
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```


# Multiple Linear Regression (Mean)

```{r}
main %>% 
  group_by(ID, time_span) %>% 
  summarize(disruption_factor = mean(disruption_factor,
                                     na.rm = T),
            confidence_factor = mean(confidence_factor,
                                     na.rm = T),
            teaching_experience = mean(teaching_experience),
            heart_rate = mean(heart_rate_std)
            ) %>% 
  ungroup() -> data_regression_mean

for (i in unique(data_regression_mean$time_span)) {
  
  cache <- data_regression_mean %>% 
    filter(time_span == i)
  
  regr1 <-
    lm(heart_rate ~ teaching_experience,
    data = cache) 
  
  assign(value = regr1,
         x = paste0("regr_", i, "1"))
  
  regr2 <-
    lm(heart_rate ~ teaching_experience + disruption_factor,
    data = cache) 
  
  assign(value = regr2,
         x = paste0("regr_", i, "2"))
  
  regr3 <-
    lm(heart_rate ~ teaching_experience + confidence_factor,
    data = cache) 
  
  assign(value = regr3,
         x = paste0("regr_", i, "3"))
  
  regr4 <-
    lm(heart_rate ~ teaching_experience + disruption_factor + confidence_factor,
    data = cache)
  
  assign(value = regr4,
         x = paste0("regr_", i, "4"))

}

# Hier habe ich immer nur die Modelle getauscht. Also statt regr_end1 regr_teaching1 usw.

summary(regr_teaching1)
summary(regr_teaching2)
summary(regr_teaching3)
summary(regr_teaching4)

```

# Plot

```{r}
df_heart_rate <- 
  main %>% 
  mutate(time = time / 60) %>% 
  filter(time_span == "overall") %>%
  dplyr::select("ID","time","heart_rate") %>% 
  distinct() %>% 
  mutate(type = "a. Heart Rate (in beats per minute)")

df_heart_rate_std <- 
  main %>% 
  mutate(time = time / 60) %>% 
  filter(time_span == "overall") %>%
  dplyr::select("ID","time","heart_rate_std") %>% 
  distinct() %>% 
  transmute(ID,
            time,
            type = "b. Heart Rate (standardized)",
            heart_rate = heart_rate_std)

# left_join(x = df_heart_rate,
#           y = df_heart_rate_std,
#           by = c("ID","time")) %>% 
bind_rows(df_heart_rate,
          df_heart_rate_std
          ) %>% 
  ggplot(mapping = aes(x = time,
                       y = heart_rate
                       )
         ) +
  # geom_point(alpha = 0.05) + 
  geom_smooth(se = T,
              size = 0.5,
              colour = "black",
              level = 0.99) +
  scale_color_viridis_d(option = "A",
                        end = 0.8) +
  scale_linetype_manual(values = c(1, 6)) +
  # scale_x_continuous(expand = c(0, NA),
  #                    breaks = seq(0, 120, 10)) +
  scale_x_continuous(expand = c(0.01,0)) + 
  labs(x = "Time (in minutes)",
       #y = "Heart Rate (in Beats per Minute)",
       y = "",
       # title = "Figure #",
       # subtitle = "Overall Course of Average Heartrate",
       # caption = expression(paste(italic("Note: "),
       #                            "The shadow around the line represents the 99% confidence interval. 
       #                            We used the ggplot2 package (v3.3.3; Wickham, 2016) to calculate the moving average of the course."))
       ) +
  #ggtitle("Overall Course of Average Heartrate") +
  theme_apa() + 
  # theme(plot.subtitle = element_text(face = "italic"),
  #       plot.caption = element_text(hjust = 0),
  #       axis.line = element_line(colour = "black"),
  #       panel.grid.major = element_blank(),
  #       panel.grid.minor = element_blank(),
  #       panel.border = element_blank(),
  #       panel.background = element_blank()) +
  facet_wrap(~ type,
             ncol = 2,
             scales = "free_y")

ggsave(filename = "plots_publication/loess_plot_std_unstd.png",
       width = 16,
       height = 12,
       units = "cm")
```


```{r}
  main %>% 
  filter(time_span != "overall") %>%
  dplyr::select("ID","time_span", "time","heart_rate_std") %>% 
  mutate(time_span = factor(time_span,
                            levels = c("preparation","teaching","post","interview","end"),
                            labels = c("(1) Pre-teaching\nphase","(2) Teaching\nphase","(3) Post-teaching\nphase","(4) Interview\nphase","(5) End\nphase"))) %>% 
  distinct() %>%
  group_by(time_span) %>% 
  summarise(z_mean = mean(heart_rate_std),
            z_sd = sd(heart_rate_std),
            z_t = qt(p = 0.01 / 2,      # 0.01 KI
               df = n() - 1,
               lower.tail = F
               ),
            z_error = z_sd / sqrt(n()),
            lower = z_mean - z_t * z_error,
            upper = z_mean + z_t * z_error,
            ) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = factor(0),
                       y = z_mean)) + 
  geom_point() +
  geom_errorbar(mapping = aes(ymin = lower,
                              ymax = upper),
                width = 0.2) +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  labs(x = "",
       y = "Standardized mean HR",
       caption = expression(paste(italic("Note: "), 
                                  "The dotted line represents the null effect; bars represent the 1% confidence interval. "
                                  )
                            )
       ) +
  facet_grid(cols = vars(time_span)) +
  theme_apa() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.caption = element_text(hjust = 0))

ggsave(filename = "plots_publication/mean_plot.png",
       width = 20,
       height = 12,
       units = "cm")
```



# Multiple Linear Regression (Slope)

# Pre Teaching Phase

```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarize(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  mutate(posneg = if_else(condition = slope < 0,
                          true = "negative",
                          false = "positive"))

fit_pre_1 <-
  df_multi %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ disruption * posneg)

summary(fit_pre_1)

fit_pre_2 <-
  df_multi %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ confidence:posneg)

summary(fit_pre_2)


fit_pre_3 <-
  df_multi %>% 
  mutate(teaching_experience = log(teaching_experience + 1)) %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ teaching_experience:posneg)

summary(fit_pre_3)


fit_pre_4 <-
  df_multi %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ confidence:posneg + disruption:posneg)

summary(fit_pre_4)

fit_pre_5 <-
  df_multi %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ posneg:confidence + posneg:disruption + posneg:teaching_experience)

summary(fit_pre_5)


stargazer::stargazer(fit_pre_1, fit_pre_2,fit_pre_3, fit_pre_4, fit_pre_5,
                     type = "html",
                     caption = "Pre Teaching Phase",
                     dep.var.labels = "Slope",
                     # order = c(1, 2, 3),
                     # covariate.labels = c("Disruption Factor",
                     #                      "Confidence Factor",
                     #                      "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )

fit_pre_3$model %>%
  mutate(fitted.values = fit_pre_3$fitted.values) %>% 
  ggplot(mapping = aes(x = teaching_experience,
                       y = slope
                       )
         ) +
  geom_point(mapping = aes(group = posneg)) +
          geom_line(mapping = aes(y = fitted.values,
                                  group = posneg)) +
  geom_smooth(method = "lm",
              se = F,
              linetype = "dashed") +
        # geom_point(alpha = 0.5,
        #            size = 0.5) +
        theme_apa()
      

```

# Teaching Phase

```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarize(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  mutate(posneg = if_else(condition = slope < 0,
                          true = "negative",
                          false = "positive"))
fit_teach_1 <-
  df_multi %>% 
  filter(Phase == "Teaching Phase") %>% 
  split(.$posneg) %>% 
  map(~ lm(slope ~ disruption,
           data = .))
  
df_multi %>% 
  filter(Phase == "Teaching Phase") %$% 
  lm(slope ~ disruption:posneg)

fit_teach_2 <-
  df_multi %>% 
  filter(Phase == "Teaching Phase") %$% 
  lm(slope ~ confidence)

fit_teach_3 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ teaching_experience)

fit_teach_4 <-
  df_multi %>% 
  filter(Phase == "Teaching Phase") %$% 
  lm(slope ~ confidence + disruption)

fit_teach_5 <-
  df_multi %>% 
  filter(Phase == "Teaching Phase") %$% 
  lm(slope ~ confidence + disruption + teaching_experience)

stargazer::stargazer(fit_teach_1, fit_teach_2,fit_teach_3, fit_teach_4, fit_teach_5,
                     type = "html",
                     caption = "Teaching Phase",
                     dep.var.labels = "Slope",
                     order = c(1, 2, 3),
                     covariate.labels = c("Disruption Factor",
                                          "Confidence Factor",
                                          "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )
```


# Post Teaching Phase

```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarize(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  mutate(posneg = if_else(condition = slope < 0,
                          true = "negative",
                          false = "positive"))

fit_post_1 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %>% 
  split(.$posneg) %>% 
  map(~ lm(slope ~ disruption,
           data = .))
  
df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ disruption:posneg)

fit_post_2 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ confidence)

fit_post_3 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ teaching_experience)

fit_post_4 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ confidence + disruption)

fit_post_5 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ confidence + disruption + teaching_experience)

stargazer::stargazer(fit_post_1, fit_post_2,fit_post_3, fit_post_4, fit_post_5,
                     type = "html",
                     caption = "Post Teaching Phase",
                     dep.var.labels = "Slope",
                     order = c(1, 2, 3),
                     covariate.labels = c("Disruption Factor",
                                          "Confidence Factor",
                                          "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )
```


# Interview Phase

```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarize(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  mutate(posneg = if_else(condition = slope < 0,
                          true = "negative",
                          false = "positive"))

fit_inter_1 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %>% 
  split(.$posneg) %>% 
  map(~ lm(slope ~ disruption,
           data = .))
  
df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ disruption:posneg)

fit_inter_2 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ confidence)

fit_inter_3 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ teaching_experience)

fit_inter_4 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ confidence + disruption)

fit_inter_5 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ confidence + disruption + teaching_experience)

stargazer::stargazer(fit_post_1, fit_post_2,fit_post_3, fit_post_4, fit_post_5,
                     type = "html",
                     caption = "Interview Phase",
                     dep.var.labels = "Slope",
                     order = c(1, 2, 3),
                     covariate.labels = c("Disruption Factor",
                                          "Confidence Factor",
                                          "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )
```


# End Phase

```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarize(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  mutate(posneg = if_else(condition = slope < 0,
                          true = "negative",
                          false = "positive"))

fit_end_1 <-
  df_multi %>% 
  filter(Phase == "End Phase") %>% 
  split(.$posneg) %>% 
  map(~ lm(slope ~ disruption,
           data = .))
  
df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ disruption:posneg)

fit_end_2 <-
  df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ confidence)

fit_end_3 <-
  df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ teaching_experience)

fit_end_4 <-
  df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ confidence + disruption)

fit_end_5 <-
  df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ confidence + disruption + teaching_experience)

stargazer::stargazer(fit_post_1, fit_post_2,fit_post_3, fit_post_4, fit_post_5,
                     type = "html",
                     caption = "End Phase",
                     dep.var.labels = "Slope",
                     order = c(1, 2, 3),
                     covariate.labels = c("Disruption Factor",
                                          "Confidence Factor",
                                          "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )
```
