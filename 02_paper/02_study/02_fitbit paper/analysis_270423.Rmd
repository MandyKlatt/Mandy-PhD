---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	error = FALSE,
	message = FALSE,
	warning = FALSE
)
```
# Packages & read in data
```{r}
library(needs)
needs(ltm,
      xtable,
      broom,
      ppcor,
      jtools,
      lm.beta,
      janitor,
      lubridate,
      readxl,
      ggthemes,
      gridExtra,
      imputeTS,
      DescTools,
      cowplot,
      rstatix,
      ggpubr,
      lme4,
      lmerTest,
      viridis,
      gridExtra,
      gridtext,
      magrittr,
      PerformanceAnalytics,
      Hmisc,
      corrplot,
      tidyverse,
      ggplot2,
      lavaan,
      lm.beta,
      psych,
      stats)


# disruption & confidence rating
df_rating <- 
  excel_sheets("data/Coding_SRI.xlsx") %>% 
  map_df(~read_xlsx("data/Coding_SRI.xlsx",.)) %>% # read in data with two sheets
  dplyr::select(ID, # select relevant columns 
         "disruption_factor", # -99 = subject did not notice event; -100 = experimenter did not asked for event
         "confidence_factor",
         "event"
         ) %>% 
  mutate(disruption_factor = ifelse(disruption_factor < 0,
                                    yes = NA,
                                    no = disruption_factor
                                    ),
         confidence_factor = ifelse(confidence_factor < 0,
                                   yes = NA,
                                   no = confidence_factor),
         event = as_factor(event)
         )

# demographic data
df_demo <- 
  read_excel("./data/data_empschul_labor_lehrperson.xlsx") %>% # read in excel 
  transmute(ID = LI06_05, # select and rename relevant columns 
            gender = factor(LI02_01_1,
                            levels = 1:2,
                            labels = c("male","female")
                            ),
            age = LI03_01, # 1 = male; 2 = female
            teaching_experience = LI04_01)

# merge two data frames by ID 
df_merge <- merge(df_demo,
                  df_rating,
                  by = "ID") %>% 
  filter(!ID %in% c("126", # exclude cases with no fitbit data (to check see data Heart Rate)
                    "132")
         )

# rm(list = c("df_demo","df_rating"))


data_path <- "./data/heart_rate_data"

main <-
map(.x = dir(path = data_path,
             pattern = ".csv"),
    ~ read_csv(file.path(data_path, .), 
               id = "id",
               col_types = c("t","n")
               ) %>% 
  mutate(time = .$Time - min(.$Time),
         time = as.numeric(time),
         heart_rate = `Heart Rate`,
         ID = id,
         time_span = case_when(str_detect(string = id, pattern = "_a") ~ "end",
                               str_detect(string = id, pattern = "_m") ~ "teaching",
                               str_detect(string = id, pattern = "_p") ~ "preparation",
                               str_detect(string = id, pattern = "_s") ~ "post",
                               str_detect(string = id, pattern = "_i") ~ "interview",
                               TRUE ~ "overall"
                               ),
         ID = str_extract(string = ID,
                          pattern = "[:digit:]{3}"),
         ID = as.numeric(ID)
      ) %>%
    # filter(time <= 600) %>% # filter for 10min intervals
    filter(time <= 7200) %>% # filter for 2 hours (maximal duration of study)
    dplyr::select(!c("Time","Heart Rate","id"))
    ) %>%
  bind_rows()

main <-
  left_join(main, df_merge,
            by = "ID")

main <- 
  main %>% 
  dplyr::select("time", "heart_rate", "ID", "time_span") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  dplyr::summarise(mean_heart = mean(heart_rate),
            sd_heart = sd(heart_rate)) %>%
  ungroup() %>% 
  right_join(x = .,
             y = main,
             by = "ID") %>% 
  filter(!(time_span == "teaching" & time > 600)) %>%
  mutate(heart_rate_std = (heart_rate - mean_heart)/
           sd_heart)
   

## count for individuals 
main %>% 
  filter(time >= 7200) %>% 
  distinct(ID, .keep_all = TRUE) -> filter_overall

```

# Descriptives
```{r descriptive statistics}

# # Count for in-service and pre-service teachers
# # Remove duplicate cases
# distinct_df <- distinct(main, ID, gender, .keep_all = TRUE)
# 
# # Count individual cases
# case_summary <- distinct_df %>%
#   filter(ID > 200) %>% 
#   count(gender == "male")
# print(case_summary)


# Mean, SD and range for overall (unstandardized)
descrip_hr_overall <- main %>%
  filter(time_span %in% c("overall")) %>% 
  summarise(N = n_distinct(ID),
            "M heart rate in bpm" = round(mean(heart_rate),
                                     digits = 2),
            "SD heart rate in bpm" = round(sd(heart_rate),
                                      digits = 2),
            "Min heart rate in bpm" = min(heart_rate),
            "Max heart rate in bpm" = max(heart_rate)
  )

# Mean, SD and range for overall (standardized)
descrip_hr_overall_std <- main %>%
  filter(time_span %in% c("overall")) %>% 
  summarise(N = n_distinct(ID),
            "M std heart rate in bpm" = round(mean(heart_rate_std),
                                              digits = 2),
            "SD std heart rate in bpm" = round(sd(heart_rate_std),
                                               digits = 2),
            "Min std heart rate in bpm" = round(min(heart_rate_std),
                                                digits = 2),
            "Max heart rate in bpm" = round(max(heart_rate_std),
                                            digits = 2)
            )

# Mean, SD and range for individual phases (unstandardized)
descrip_hr_phases <- main %>% 
  filter(!time_span %in% c("overall")) %>% 
  group_by(time_span) %>% 
  summarise(N = n_distinct(ID),
            "M heart rate in bpm" = round(mean(heart_rate),
                                     digits = 2),
            "SD heart rate in bpm" = round(sd(heart_rate),
                                      digits = 2),
            "Min heart rate in bpm" = min(heart_rate),
            "Max heart rate in bpm" = max(heart_rate)
  )

# Mean, SD and range for individual phases (standardized)
descrip_hr_phases_std <- main %>% 
  filter(!time_span %in% c("overall")) %>% 
  group_by(time_span) %>% 
  summarise(N = n_distinct(ID),
            "M heart rate in bpm" = round(mean(heart_rate_std),
                                     digits = 2),
            "SD heart rate in bpm" = round(sd(heart_rate_std),
                                      digits = 2),
            "Min heart rate in bpm" = round(min(heart_rate_std),
                                            digits = 2),
            "Max heart rate in bpm" = round(max(heart_rate_std),
                                            digits = 2)
  )

# # format and insert table in manuscript
# descrip_hr_phases %>%
# papaja::apa_table(
#   caption = "Mean, SD and range for teachers' heart rate in individual phases",
#   # note = "Write Note here",
#   escape = TRUE, # if TRUE special Latex characters are escaped; if this is turned to F captions cannot be rendered. I don't know why...
#   placement = "h", # position of table in page:  exact location (h), at the top (t), bottom (b)
#   font_size = "tiny" # options are tiny, scriptsize, footnotesize, small, normalsize (default), large, Large, LARGE, huge, Huge
#   )

# Mean, SD and range for disruption and confidence factor
rating_table <- 
  df_rating %>% 
  filter(!is.na(confidence_factor),
         !is.na(disruption_factor)) %>% 
   summarise(N = n_distinct(ID), 
            "M disruption factor" = round(mean(disruption_factor),
                                     digits = 2),
            "SD disruption factor" = round(sd(disruption_factor),
                                      digits = 2),
            "Min disruption factor" = min(disruption_factor),
            "Max disruption factor" = max(disruption_factor),
            "M confidence factor" = round(mean(confidence_factor),
                                     digits = 2),
            "SD confidence factor" = round(sd(confidence_factor),
                                      digits = 2),
            "Min confidence factor" = min(confidence_factor),
            "Max confidence factor" = max(confidence_factor)
            )

```

# Plots
```{r fig.width = 10,results='hide',fig.keep='all'}

## Overall Course Plot (std. vs. unstd.)
df_heart_rate <- 
  main %>% 
  mutate(time = time / 60) %>% 
  filter(time_span == "overall") %>%
  dplyr::select("ID","time","heart_rate") %>% 
  distinct() %>% 
  mutate(type = "a. Heart Rate (in beats per minute)")

df_heart_rate_std <- 
  main %>% 
  mutate(time = time / 60) %>% 
  filter(time_span == "overall") %>%
  dplyr::select("ID","time","heart_rate_std") %>% 
  distinct() %>% 
  transmute(ID,
            time,
            type = "b. Heart Rate (standardized)",
            heart_rate = heart_rate_std)

bind_rows(df_heart_rate,
          df_heart_rate_std
          ) %>% 
  ggplot(mapping = aes(x = time,
                       y = heart_rate
                       )
         ) +
  geom_smooth(se = T,
              size = 0.5,
              colour = "black",
              level = 0.99) +
  scale_color_viridis_d(option = "A",
                        end = 0.8) +
  scale_linetype_manual(values = c(1, 6)) +
  scale_x_continuous(expand = c(0.01,0)) + 
  labs(x = "Time (in minutes)",
       y = "",
       ) +
  theme_apa() + 
  facet_wrap(~ type,
             ncol = 2,
             scales = "free_y")

ggsave(filename = "plots_publication/loess_plot_std_unstd.png",
       width = 16,
       height = 12,
       units = "cm")


## Mean Plot
main %>% 
  filter(time_span != "overall") %>%
  dplyr::select("ID","time_span", "time","heart_rate_std") %>% 
  mutate(time_span = factor(time_span,
                            levels = c("preparation","teaching","post","interview","end"),
                            labels = c("Pre-teaching\nInterval","Teaching\nInterval","Post-teaching\nInterval","Interview\nInterval","End\nInterval"))) %>% 
  distinct() %>%
  group_by(time_span) %>% 
  summarise(z_mean = mean(heart_rate_std),
            z_sd = sd(heart_rate_std),
            z_t = qt(p = 0.05 / 2,      # 0.05 KI
               df = n() - 1,
               lower.tail = F
               ),
            z_error = z_sd / sqrt(n()),
            lower = z_mean - z_t * z_error,
            upper = z_mean + z_t * z_error,
            ) %>% 
  ungroup() %>% 
  ggplot(mapping = aes(x = factor(0),
                       y = z_mean)) + 
  geom_point() +
  geom_errorbar(mapping = aes(ymin = lower,
                              ymax = upper),
                width = 0.2) +
  geom_hline(yintercept = 0,
             linetype = "dashed") +
  ylim(-1.5, 1.5) + 
  scale_y_continuous(breaks=seq(-1.5, 1.5, 0.5), 
                     limits=c(-1.5, 1.5)
                     ) + 
  labs(x = "Time (in Minutes)",
       y = "Standardized Mean Heart Rate",
       # caption = expression(paste(italic("Note: "),
       #                            "The shadow around the line represents the 95% confidence interval."
       #                            )
       #                      )
       ) +
  facet_grid(cols = vars(time_span),
             scales = "free_x") +
  theme_apa() +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.caption = element_text(hjust = 0))

ggsave(filename = "plots_publication/mean_plot.png",
       width = 20,
       height = 12,
       units = "cm")


## Box Plot (over 81 participants) 
box_plot <-
  main %>% 
  filter(time_span != "overall") %>%   
  dplyr::select("ID",
         "time_span",
         "heart_rate_std") %>% 
  mutate(time_span = fct_recode(time_span,
                                "Pre-teaching Interval" = "preparation",
                                "Teaching Interval" = "teaching",
                                "Post-teaching Interval" = "post",
                                "Interview Interval" = "interview",
                                "End Interval" = "end"
                                ),
         time_span = factor(time_span,
                            levels = c("Pre-teaching Interval",
                                       "Teaching Interval",
                                       "Post-teaching Interval",
                                       "Interview Interval",
                                       "End Interval"
                                       ),
                            labels = c("Pre-Teaching\nInterval",
                                       "Teaching\nInterval",
                                       "Post-Teaching\nInterval",
                                       "Interview\nInterval",
                                       "End\nInterval")
                            )
         ) %>%
  distinct() %>% 
  group_by(ID, time_span) %>%
  summarise(mean_hr_std = 
              mean(heart_rate_std, 
                   na.rm = TRUE)
            ) %>% 
  ggplot(mapping = aes(x = time_span,
                       y = mean_hr_std
                       )
         ) +
  geom_boxplot()+
  scale_y_continuous(breaks=seq(-2, 2, 1), 
                     limits=c(-2, 2)
                     ) +   
  # geom_jitter(width = 0.2) +
  theme_apa() + 
  theme(axis.text.x = 
          element_text(
            color="black",
            size = 12),
        plot.caption = element_text(hjust = 0)
        ) + 
  labs(x = "",
       y = "Mean Standardized Heart Rate",
       caption = expression(
         paste(italic("Note: N"), 
               "= 81 participants per interval. Fig. shows median (bold line), interquartile range (box) and outliers (dots)."
         )
       ))

box_plot

ggsave(filename = "plots_publication/box_plot.png",
       plot = box_plot,
       width = 20,
       height = 12,
       units = "cm")


## LM Plot
lm_plot <-
  main %>%
  filter(time_span != "overall") %>%
  dplyr::select("ID","time_span", "time","heart_rate_std") %>%
  mutate(time_span = factor(time_span,
                            levels = c("preparation","teaching","post","interview","end"),
                            labels = c("Pre-Teaching\nInterval","Teaching\nInterval","Post-Teaching\nInterval","Interview\nInterval","End\nInterval")
                            ),
         time = time / 60
         ) %>%
  distinct() %>%
  ggplot(mapping = aes(x = time,
                       y = heart_rate_std
                       )
         ) +
  geom_smooth(method = "lm",
              se = T,
              size = 0.5,
              colour = "black",
              level = 0.95) +
  scale_color_viridis_d(option = "A",
                        end = 0.8) +
  scale_x_continuous(breaks = seq(0, 10, 2)) +
  scale_y_continuous(breaks = seq(from = -1, to = 1, by = 0.5)) +
  labs(x = "Time (in Minutes)",
       y = "Mean Standardized Heart Rate",
       caption = expression(paste(italic("Note: "),
                                  "The shadow around the line represents the 95% confidence interval."
                                  )
                            )
       ) +
  theme_apa() +
  theme(plot.subtitle = element_text(face = "italic"),
        plot.caption = element_text(hjust = 0)) +
  facet_grid(cols = vars(time_span),
             scales = "free_x")

# lm_plot_phases <-
#   main %>% 
#   filter(time_span != "overall") %>%
#   dplyr::select("ID", "time_span", "time", "heart_rate_std") %>% 
#   mutate(time_span = factor(time_span,
#                             levels = c("preparation","teaching","post","interview","end"),
#                             labels = c("Pre-teaching\nphase", "Teaching\nphase", "Post-teaching\nphase", "Interview\nphase", "End\nphase"))) %>% 
#   ggplot(aes(x = time, 
#              y = heart_rate_std, 
#              color = ID)
#          ) +
#   geom_smooth(method = "lm", 
#               se = TRUE, 
#               aes(group = ID), 
#               size = 0.5) + # Regression per ID
#   geom_smooth(data = . %>% 
#                 group_by(time_span) %>% 
#                 summarise_all(mean), 
#               method = "lm", 
#               se = TRUE, color = "black", 
#               size = 1) + # Overall regression
#   scale_color_viridis_d(option = "A", 
#                         end = 0.8) +
#   scale_linetype_manual(values = c(1, 6)) +
#   labs(x = "Time (in Seconds)", 
#        y = "", 
#        subtitle = "") +
#   theme_apa() +
#   theme(axis.title.y = element_blank()) +
#   facet_grid(cols = vars(time_span), 
#              scales = "free_x")

ggsave(filename = "plots_publication/lm_plot.png",
       plot = lm_plot,
       width = 20,
       height = 12,
       units = "cm")
```

# Slopes and Intercepts
```{r}
df_regression <- 
  main %>% 
  filter(time_span != "overall") %>%
  dplyr::select("ID", "time_span","time","heart_rate_std","heart_rate") %>% 
  distinct() %>% 
  mutate(time = time / 60) %>% 
  mutate(ID = as_factor(ID),
         Phase = factor(time_span,
                           levels = c("preparation","teaching","post","interview","end"),
                            labels = c("Pre Teaching Phase","Teaching Phase","Post Teaching Phase","Interview Phase","End Phase")
                           )
         )

fix_models <-
  df_regression %>%
  split(.$Phase) %>%
  map( ~ lm(formula = heart_rate_std ~ 0 + ID + time:ID,
            data = .)) %>%
  map(
    ~ coef(.) %>%
      tibble::as_tibble(.,
                        rownames = "name") %>%
      transmute(
        type = if_else(str_detect(name,
                                  ":"),
                       true = "slope",
                       false = "intercept"),
        id = str_remove_all(name,
                            "[^[:digit:]]"),
        value = value
      ),
    
  ) %>%
  bind_rows(.id = "Phase") %>%
  pivot_wider(names_from = type,
              values_from = value)

p.values_slope <-
  fix_models %>%
  split(.$Phase) %>%
  map( ~ t.test(x = .$slope,
                mu = 0)$p.value) %>%
  bind_rows(.id = "Phase") %>%
  pivot_longer(cols = everything(),
               names_to = "Phase",
               values_to = "p.value_slope")

p.values_intercept <-
  fix_models %>%
  split(.$Phase) %>%
  map( ~ t.test(x = .$intercept,
                mu = 0)$p.value) %>%
  bind_rows(.id = "Phase") %>%
  pivot_longer(cols = everything(),
               names_to = "Phase",
               values_to = "p.value_intercept")

sd_mean <-
  fix_models %>%
  group_by(Phase) %>%
  dplyr::summarise(
    mean_slope = mean(slope),
    sd_slope = sd(slope),
    mean_intercept = mean(intercept),
    sd_intercept = sd(intercept)
  )

table_data <- 
  right_join(x = sd_mean,
             y = p.values_intercept,
             by = "Phase") %>% 
  right_join(x = .,
             y = p.values_slope,
             by = "Phase") %>% 
  transmute(Phase = factor(Phase,
                           levels = c("Pre Teaching Phase","Teaching Phase","Post Teaching Phase","Interview Phase","End Phase")
                           ),
            n = NA,
            `Mean(Intercept)` = round(mean_intercept, digits = 3),
            `SD(Intercept)` = round(sd_intercept, digits = 3),
            `p-Value (Intercept)` = p.value_intercept,
            `Mean(Slope)` = round(mean_slope, digits = 3), 
            `SD(Slope)` = round(sd_slope,digits = 3),
            `p-Value (Slope)` = p.value_slope, 
            ) %>% 
  arrange(Phase)

table_data$n[table_data$Phase == "Pre Teaching Phase"] <- df_regression %>% filter(Phase == "Pre Teaching Phase") %>% pull(heart_rate_std) %>% length()
table_data$n[table_data$Phase == "Teaching Phase"] <- df_regression %>% filter(Phase == "Teaching Phase") %>% pull(heart_rate_std) %>% length()
table_data$n[table_data$Phase == "Post Teaching Phase"] <- df_regression %>% filter(Phase == "Post Teaching Phase") %>% pull(heart_rate_std) %>% length()
table_data$n[table_data$Phase == "Interview Phase"] <- df_regression %>% filter(Phase == "Interview Phase") %>% pull(heart_rate_std) %>% length()
table_data$n[table_data$Phase == "End Phase"] <- df_regression %>% filter(Phase == "End Phase") %>% pull(heart_rate_std) %>% length()

table_data %>% 
  knitr::kable(.)
```

# Plots for all phases
```{r}
mods <-   
  df_regression %>% 
  split(.$time_span) %>% 
  map(~ lm(formula = heart_rate_std ~ 0 + ID + time:ID,
       data = .
       )
      )

graph_data <- 
  df_regression %>% 
  split(.$time_span) 

example <- list(mod = mods$preparation, data = graph_data$preparation)


list(`Preparation Phase` = list(name = "Pre-Teaching ", mod = mods$preparation, data = graph_data$preparation),
     `Teaching Phase` = list(name = "Teaching Phase", mod = mods$teaching, data = graph_data$teaching),
     `Post Teaching Phase` = list(name = "Post Teaching Phase",mod = mods$post, data = graph_data$post),
     `Interview Phase` = list(name = "Interview Phase",mod = mods$interview, data = graph_data$interview),
     `End Phase` = list(name = "End Phase",mod = mods$end, data = graph_data$end)
     ) %>% 
  map(~ ggplot(data = .$data,
               mapping = aes(x = time,
                             y = heart_rate_std,
                             group = ID)) +
        geom_line(mapping = aes(y = fitted(.$mod)),
                  color = "blue",
                  size = 1) +
        geom_point(alpha = 0.5,
                   size = 0.5) +
        labs(title = .$name,
             y = "Heart Rate (Standardized)",
             x = "Time (in Seconds)") +
        facet_wrap( ~ ID, nrow = 6) +
        theme_apa()
      )
```

# t-Tests 
## using heart rate means
```{r}
df_ttest <- 
  df_regression %>% 
  group_by(ID, time_span) %>% 
  summarise(mean_heart_rate = mean(heart_rate_std)) %>% 
  ungroup()
```
## Teaching vs. Pre-Teaching (mean HR)

```{r}
df_ttest %$% 
  t.test(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "preparation"],
         paired = T)

df_ttest %$% 
  CohenD(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "preparation"],
         pooled = T)
```

## Teaching vs. Post-Teaching (mean HR)

```{r}
df_ttest %$% 
  t.test(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "post"],
         paired = T)

df_ttest %$% 
  CohenD(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "post"],
         pooled = T)
```


## Teaching vs. Interview (mean HR)

```{r}
df_ttest %$% 
  t.test(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "interview"],
         paired = T)

df_ttest %$% 
  CohenD(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "interview"],
         pooled = T)
```

## Teaching vs. End (mean HR)
```{r}
df_ttest %$% 
  t.test(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "end"],
         paired = T)

df_ttest %$% 
  CohenD(x = .$mean_heart_rate[.$time_span == "teaching"],
         y = .$mean_heart_rate[.$time_span == "end"],
         pooled = T)
```


## ANOVA & planned constrasts
```{r}
# Data wrangling - preparing data for ANOVA
df_anova <-
  main %>% 
  filter(time_span != "overall") %>%   
  dplyr::select("ID",
         "time_span",
         "heart_rate_std") %>% 
  mutate(time_span = fct_recode(time_span,
                                "Pre-teaching interval" = "pre",
                                "Teaching interval" = "main",
                                "Post-teaching interval" = "subsequent",
                                "Interview interval" = "interview",
                                "End interval" = "after"
                                ),
         time_span = factor(time_span,
                            levels = c("Pre-teaching interval",
                                       "Teaching interval",
                                       "Post-teaching interval",
                                       "Interview interval",
                                       "End interval"
                                       )
                            )
         ) %>%
  distinct() %>% 
  group_by(ID, time_span) %>%
  summarise(mean_hr_std = mean(heart_rate_std, na.rm = TRUE))

# Counting participants in individual phases
table(df_anova['time_span'])

# descriptive analysis
describeBy(df_anova$mean_hr_std,
           df_anova$time_span)

# Visualization
bxp <- ggboxplot(df_anova, x = "time_span", y = "mean_hr_std", add = "point")
bxp

# Check for outliers
outliers <-
  df_anova %>%
  group_by(time_span) %>%
  identify_outliers(mean_hr_std)

# check for normality assumption --> can be checked by computing Shapiro-Wilk test for each time point. If the data is normally distributed, the p-value should be greater than 0.05
norm_assump <-
  df_anova %>%
  group_by(time_span) %>%
  shapiro_test(mean_hr_std)

# QQ plot draws the correlation between a given data and the normal distribution. 
plot <- 
  ggqqplot(df_anova, "mean_hr_std", facet.by = "time_span")

df_anova_subset <- subset(df_anova, select = c(time_span, mean_hr_std))

# # anova
# res.aov <- rstatix::anova_test(data = df_anova_subset,
#                                dv = mean_hr,
#                                wid = ,
#                                within = time_span)
# get_anova_table(res.aov)

# anova
df_anova_phase <- 
  aov(df_anova_subset$mean_hr_std ~ df_anova_subset$time_span)
summary(df_anova_phase)

# effect size for ANOVA
DescTools::EtaSq(df_anova_phase)
f = sqrt (0.7202944/ (1-0.7202944))

# planned constrasts
model <- aov(mean_hr_std ~ time_span, data = df_anova_subset)
summary (model)

contrast1 <- c(-1, 1, 0, 0, 0)
contrast2 <- c(0, 1, -1, 0, 0)
contrast3 <- c(0, 1, 0, -1, 0)
contrast4 <- c(0, 1, 0, 0, -1)

contrasts(df_anova_subset$time_span) <- cbind(contrast1,
                                              contrast2,
                                              contrast3,
                                              contrast4)

model2 <- aov(mean_hr_std ~ time_span, data = df_anova_subset)
summary(model2)

summary.aov(model2, 
            split = list (time_span = list ("Teaching interval vs. Pre-teaching interval" = 1,
                                            "Teaching interval vs. Post-teaching interval" = 2,
                                            "Teaching interval vs. Interview interval" = 3,
                                            "Teaching interval vs. End interval" = 4
                                            )
                          )
            )

```


# t-Tests 
## using mean Slope 
```{r}
df_ttest_slope <- 
  fix_models %>% 
  group_by(id, Phase) %>% 
  summarise(mean_slope = mean(slope)) %>% 
  ungroup()
```


## Teaching vs. Interview (mean slope)
```{r}
df_ttest_slope %$% 
  t.test(x = .$mean_slope[.$Phase == "Teaching Phase"],
         y = .$mean_slope[.$Phase == "Interview Phase"],
         paired = T)

df_ttest_slope %$% 
  CohenD(x = .$mean_slope[.$Phase == "Teaching Phase"],
         y = .$mean_slope[.$Phase == "Interview Phase"],
         pooled = T)
```
## Teaching vs. End (mean slope)

```{r}
df_ttest_slope %$% 
  t.test(x = .$mean_slope[.$Phase == "Teaching Phase"],
         y = .$mean_slope[.$Phase == "End Phase"],
         paired = T)

df_ttest_slope %$% 
  CohenD(x = .$mean_slope[.$Phase == "Teaching Phase"],
         y = .$mean_slope[.$Phase == "End Phase"],
         pooled = T)
```

## Interview vs. End (mean slope)
```{r}
df_ttest_slope %$% 
  t.test(x = .$mean_slope[.$Phase == "Interview Phase"],
         y = .$mean_slope[.$Phase == "End Phase"],
         paired = T)

df_ttest_slope %$% 
  CohenD(x = .$mean_slope[.$Phase == "Interview Phase"],
         y = .$mean_slope[.$Phase == "End Phase"],
         pooled = T)
```


### Correlation 
## age x teaching experience
``` {r}
main %>% 
  filter(time_span == "overall") %>% 
  group_by(ID) %>% 
  select(ID,
         teaching_experience,
         age) -> teach_gender

cor(cor_teach_gender$teaching_experience,
    cor_teach_gender$age,
    method = c("pearson")
  ) -> cor_teach_gender

```


## Pr-teaching phase
```{r}
  main %>% 
  filter(time_span == "preparation") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         # gender = if_else(gender == "male",
         #                   true = 0,
         #                   false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) -> cor_pre

cor.test(cor_pre$heart_rate_m, cor_pre$confidence_factor_m)

# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```

## Teaching phase
```{r}
main %>% 
  filter(time_span == "teaching") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_teaching
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```


## Post-teaching phase
```{r}
main %>% 
  filter(time_span == "post") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_post
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```

## Interview phase
```{r}
main %>% 
  filter(time_span == "interview") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_interview
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```

## End phase
```{r}
main %>% 
  filter(time_span == "end") %>% 
  group_by(ID) %>% 
  transmute(heart_rate_m = mean(heart_rate_std),
            confidence_factor_m = mean(confidence_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            teaching_experience = teaching_experience,
            gender = gender
  ) %>%
  distinct() %>% 
  ungroup() %>% 
  transmute(heart_rate_m = (heart_rate_m - mean(.$heart_rate_m))/sd(.$heart_rate_m),
         confidence_factor_m = (confidence_factor_m - mean(.$confidence_factor_m))/sd(.$confidence_factor_m),
         disruption_factor_m = (disruption_factor_m - mean(.$disruption_factor_m))/sd(.$disruption_factor_m),
         gender = if_else(gender == "male",
                           true = 0,
                           false = 1),
          teaching_experience = (teaching_experience - mean(.$teaching_experience))/sd(.$teaching_experience)
         ) %>%
  pcor()  -> pcor_end
 
# knitr::kable(x = list(pcor_main$estimate, pcor_main$p.value), format = "simple") 

```




# Multiple Linear Regression (Mean) -- LOOP
```{r}
main %>% 
  group_by(ID, time_span) %>% 
  summarise(disruption_factor = mean(disruption_factor,
                                     na.rm = T),
            confidence_factor = mean(confidence_factor,
                                     na.rm = T),
            teaching_experience = mean(teaching_experience),
            heart_rate = mean(heart_rate_std)
            ) %>% 
  ungroup() -> data_regression_mean


# ## using lavaan package to get std. regression coefficients 
# MLRModel <- 'heart_rate ~ teaching_experience
#              heart_rate ~ 1'
# 
# output <- sem(model = MLRModel, data = data_regression_mean)
# summary(output, standardized = TRUE)

## loop for regression model
for (i in unique(data_regression_mean$time_span)) {
  
  cache <- data_regression_mean %>% 
    filter(time_span == i)
  
  regr1 <-
    lm(heart_rate ~ teaching_experience,
    data = cache) %>% 
    lm.beta()
  
  assign(value = regr1,
         x = paste0("regr_", i, "1"))
  
  regr2 <-
    lm(heart_rate ~ teaching_experience + disruption_factor,
    data = cache) %>% 
    lm.beta() 
  
  assign(value = regr2,
         x = paste0("regr_", i, "2"))
  
  regr3 <-
    lm(heart_rate ~ teaching_experience + confidence_factor,
    data = cache) %>% 
    lm.beta() 
  
  assign(value = regr3,
         x = paste0("regr_", i, "3"))
  
  regr4 <-
    lm(heart_rate ~ teaching_experience + disruption_factor + confidence_factor,
    data = cache) %>% 
    lm.beta()
  
  assign(value = regr4,
         x = paste0("regr_", i, "4"))

}

# Hier habe ich immer nur die Modelle getauscht. Also statt regr_end1 regr_teaching1 usw.

summary(regr_preparation1)
summary(regr_end2)
summary(regr_end3)
summary(regr_post4)

```
# Multiple Linear Regression (Slope) -- LOOP
```{r}

main %>% 
  group_by(ID, time_span) %>% 
  filter(! time_span %in% "overall") %>% 
  mutate(time_span = factor(time_span,
                            levels = c("end","interview","post","preparation","teaching"),
                            labels = c("preparation","teaching","post","interview","end")
                           )
         ) %>%
  rename(id = ID) %>% 
  summarise(disruption_factor = mean(disruption_factor,
                                     na.rm = T),
            confidence_factor = mean(confidence_factor,
                                     na.rm = T),
            teaching_experience = mean(teaching_experience),
            heart_rate = mean(heart_rate_std)
            ) -> df_slope

fix_models %>%
  mutate(id = as_factor(id),
         time_span = factor(Phase,
                           levels = c("Pre Teaching Phase","Teaching Phase","Post Teaching Phase","Interview Phase","End Phase"),
                           labels = c("preparation","teaching","post","interview","end")
                           )
         ) %>%
    group_by(id, time_span) %>% 
    summarise(slope = mean(slope)) %>% 
  ungroup() -> fix_models_slope

merge(df_slope,
      fix_models_slope,
      by=c("id", "time_span")) -> data_regression_slope


for (i in unique(data_regression_slope$time_span)) {
  
  cache <- data_regression_slope %>% 
    filter(time_span == i)
  
  regr1 <-
    lm(slope ~ teaching_experience,
    data = cache) %>% 
    lm.beta()
  
  assign(value = regr1,
         x = paste0("regr_", i, "1"))
  
  regr2 <-
    lm(slope ~ teaching_experience + disruption_factor,
    data = cache) %>% 
    lm.beta()
  
  assign(value = regr2,
         x = paste0("regr_", i, "2"))
  
  regr3 <-
    lm(slope ~ teaching_experience + confidence_factor,
    data = cache) %>% 
    lm.beta()
  
  assign(value = regr3,
         x = paste0("regr_", i, "3"))
  
  regr4 <-
    lm(slope ~ teaching_experience + disruption_factor + confidence_factor,
    data = cache) %>% 
    lm.beta()
  
  assign(value = regr4,
         x = paste0("regr_", i, "4"))

}

# Hier habe ich immer nur die Modelle getauscht. Also statt regr_end1 regr_teaching1 usw.

summary(regr_end1)
summary(regr_end2)
summary(regr_end3)
summary(regr_end4)

```


# Multiple Linear Regression (Slope)
# Pre Teaching Phase
```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarise(disruption_factor = mean(disruption_factor, na.rm = T),
            confidence_factor = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id")
  # mutate(posneg = if_else(condition = slope < 0,
  #                         true = "negative",
  #                         false = "positive"))

fit_pre_1 <-
  df_multi %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ teaching_experience)

summary(fit_pre_1)

fit_pre_2 <-
  df_multi %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ teaching_experience + disruption_factor)

summary(fit_pre_2)

summary(fit_pre_1)$r.squared - summary(fit_pre_2)$r.squared 

fit_pre_3 <-
  df_multi %>% 
  mutate(teaching_experience = log(teaching_experience + 1)) %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ teaching_experience + confidence_factor)

summary(fit_pre_3)

summary(fit_pre_1)$r.squared - summary(fit_pre_2)$r.squared - summary(fit_pre_3)$r.squared 

fit_pre_4 <-
  df_multi %>% 
  filter(Phase == "Pre Teaching Phase") %$% 
  lm(slope ~ teaching_experience + confidence + disruption)

summary(fit_pre_4)


stargazer::stargazer(fit_pre_1, fit_pre_2,fit_pre_3, fit_pre_4, fit_pre_5,
                     type = "html",
                     caption = "Pre Teaching Phase",
                     dep.var.labels = "Slope",
                     # order = c(1, 2, 3),
                     # covariate.labels = c("Disruption Factor",
                     #                      "Confidence Factor",
                     #                      "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )

fit_pre_3$model %>%
  mutate(fitted.values = fit_pre_3$fitted.values) %>% 
  ggplot(mapping = aes(x = teaching_experience,
                       y = slope
                       )
         ) +
  geom_point(mapping = aes(group = posneg)) +
          geom_line(mapping = aes(y = fitted.values,
                                  group = posneg)) +
  geom_smooth(method = "lm",
              se = F,
              linetype = "dashed") +
        # geom_point(alpha = 0.5,
        #            size = 0.5) +
        theme_apa()
      

```
# Teaching Phase

```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarise(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  # mutate(posneg = if_else(condition = slope < 0,
  #                         true = "negative",
  #                         false = "positive"))
fit_teach_1 <-
  df_multi %>% 
  filter(Phase == "Teaching Phase") %>% 
  # split(.$posneg) %>% 
  map(~ lm(slope ~ disruption,
           data = .))
  
df_multi %>% 
  filter(Phase == "Teaching Phase") %$% 
  lm(slope ~ disruption)

fit_teach_2 <-
  df_multi %>% 
  filter(Phase == "Teaching Phase") %$% 
  lm(slope ~ confidence)

fit_teach_3 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ teaching_experience)

fit_teach_4 <-
  df_multi %>% 
  filter(Phase == "Teaching Phase") %$% 
  lm(slope ~ confidence + disruption)

fit_teach_5 <-
  df_multi %>% 
  filter(Phase == "Teaching Phase") %$% 
  lm(slope ~ confidence + disruption + teaching_experience)

stargazer::stargazer(fit_teach_1, fit_teach_2,fit_teach_3, fit_teach_4, fit_teach_5,
                     type = "html",
                     caption = "Teaching Phase",
                     dep.var.labels = "Slope",
                     order = c(1, 2, 3),
                     covariate.labels = c("Disruption Factor",
                                          "Confidence Factor",
                                          "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )
```


# Post Teaching Phase

```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarise(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  mutate(posneg = if_else(condition = slope < 0,
                          true = "negative",
                          false = "positive"))

fit_post_1 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %>% 
  split(.$posneg) %>% 
  map(~ lm(slope ~ disruption,
           data = .))
  
df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ disruption:posneg)

fit_post_2 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ confidence)

fit_post_3 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ teaching_experience)

fit_post_4 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ confidence + disruption)

fit_post_5 <-
  df_multi %>% 
  filter(Phase == "Post Teaching Phase") %$% 
  lm(slope ~ confidence + disruption + teaching_experience)

stargazer::stargazer(fit_post_1, fit_post_2,fit_post_3, fit_post_4, fit_post_5,
                     type = "html",
                     caption = "Post Teaching Phase",
                     dep.var.labels = "Slope",
                     order = c(1, 2, 3),
                     covariate.labels = c("Disruption Factor",
                                          "Confidence Factor",
                                          "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )
```


# Interview Phase
```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarise(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  mutate(posneg = if_else(condition = slope < 0,
                          true = "negative",
                          false = "positive"))

fit_inter_1 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %>% 
  split(.$posneg) %>% 
  map(~ lm(slope ~ disruption,
           data = .))
  
df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ disruption:posneg)

fit_inter_2 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ confidence)

fit_inter_3 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ teaching_experience)

fit_inter_4 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ confidence + disruption)

fit_inter_5 <-
  df_multi %>% 
  filter(Phase == "Interview Phase") %$% 
  lm(slope ~ confidence + disruption + teaching_experience)

stargazer::stargazer(fit_post_1, fit_post_2,fit_post_3, fit_post_4, fit_post_5,
                     type = "html",
                     caption = "Interview Phase",
                     dep.var.labels = "Slope",
                     order = c(1, 2, 3),
                     covariate.labels = c("Disruption Factor",
                                          "Confidence Factor",
                                          "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )
```


# End Phase
```{r echo = FALSE, results='asis'}
df_multi <- 
  main %>% 
  select("ID", "disruption_factor", "confidence_factor", "teaching_experience") %>% 
  distinct() %>% 
  group_by(ID) %>% 
  summarise(disruption = mean(disruption_factor, na.rm = T),
            confidence = mean(confidence_factor, na.rm = T),
            teaching_experience) %>% 
  ungroup() %>% 
  mutate(id = as.character(ID)) %>% 
  distinct() %>% 
  right_join(x = .,
            y = fix_models,
            by = "id") %>% 
  mutate(posneg = if_else(condition = slope < 0,
                          true = "negative",
                          false = "positive"))

fit_end_1 <-
  df_multi %>% 
  filter(Phase == "End Phase") %>% 
  split(.$posneg) %>% 
  map(~ lm(slope ~ disruption,
           data = .))
  
df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ disruption:posneg)

fit_end_2 <-
  df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ confidence)

fit_end_3 <-
  df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ teaching_experience)

fit_end_4 <-
  df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ confidence + disruption)

fit_end_5 <-
  df_multi %>% 
  filter(Phase == "End Phase") %$% 
  lm(slope ~ confidence + disruption + teaching_experience)

stargazer::stargazer(fit_post_1, fit_post_2,fit_post_3, fit_post_4, fit_post_5,
                     type = "html",
                     caption = "End Phase",
                     dep.var.labels = "Slope",
                     order = c(1, 2, 3),
                     covariate.labels = c("Disruption Factor",
                                          "Confidence Factor",
                                          "Teaching Experience"),
                     keep.stat = c("n","rsq","adj.rsq")
                     )
```
