---
title: "FitBit Analysis"
author: "Peer Keßler"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, error = FALSE, warning = FALSE)
```

```{r data wrangling, include = FALSE}
library(needs)
needs(ltm,
      lm.beta,
      tidyverse,
      janitor,
      lubridate,
      readxl,
      ggthemes,
      gridExtra,
      imputeTS,
      DescTools,
      cowplot,
      rstatix,
      ggpubr,
      lme4,
      viridis)

# disruption & confidence rating
df_rating <- 
  excel_sheets("data/Coding_SRI.xlsx") %>% 
  map_df(~read_xlsx("data/Coding_SRI.xlsx",.)) %>% # read in data with two sheets
  select(ID, # select relevant columns 
         disruption_factor, # -99 = subject did not notice event; -100 = experimenter did not asked for event
         confident_factor,
         event
         ) %>% 
  mutate(disruption_factor = ifelse(disruption_factor < 0,
                                    yes = NA,
                                    no = disruption_factor
                                    ),
         confident_factor = ifelse(confident_factor < 0,
                                   yes = NA,
                                   no = confident_factor),
         event = as_factor(event)
         )

# demographic data
df_demo <- 
  read_excel("./data/data_empschul_labor_lehrperson.xlsx") %>% # read in excel 
  transmute(ID = LI06_05, # select and rename relevant columns 
            gender = factor(LI02_01_1,
                            levels = 1:2,
                            labels = c("male","female")
                            ),
            age = LI03_01, # 1 = male; 2 = female
            teaching_experience = LI04_01)

# merge two data frames by ID 
df_merge <- merge(df_demo,
                  df_rating,
                  by = "ID") %>% 
  filter(!ID %in% c("126", # exclude cases with no fitbit data (to check see data Heart Rate)
                    "132")
         )

# rm(list = c("df_demo","df_rating"))


data_path <- "./data/heart_rate_data"

main <-
map(.x = dir(path = data_path,
             pattern = ".csv"),
    ~ read_csv(file.path(data_path, .), id = "id") %>% 
  mutate(time = .$Time - min(.$Time),
         time = as.numeric(time),
         heart_rate = `Heart Rate`,
         ID = id,
         time_span = case_when(
           str_detect(string = id, pattern = "_a") ~ "after",
           str_detect(string = id, pattern = "_m") ~ "main",
           str_detect(string = id, pattern = "_p") ~ "pre"
           ),
         ID = str_extract(string = ID,
                          pattern = "[:digit:]{3}"),
         ID = as.numeric(ID)
      ) %>%
      filter(time <= 600) %>%
    select(!c("Time","Heart Rate","id"))
    ) %>%
  bind_rows()

main <-
  left_join(main, df_merge,
            by = "ID")
```

# Überblick Daten

```{r}
knitr::kable(main[1:10,], format = "simple")
```

# Verteilungen

# Geschlecht

```{r}
df_demo %>% 
  ggplot(mapping = aes(x = gender)) +
  geom_bar()
```

# Alter

```{r}
df_demo %>% 
  ggplot(mapping = aes(x = age)) +
  geom_histogram(binwidth = 5)
```

- Linkssteile Verteilung
- Möglicher Umgang: Logarithmieren

```{r}
df_demo %>% 
  ggplot(mapping = aes(x = log(age))) +
  geom_histogram(binwidth = 0.1)
```

# Alter x Geschlecht

```{r}
df_demo %>% 
  ggplot(mapping = aes(x = gender,
                       y = age
                       )
         ) +
  geom_boxplot()
```

- Alter und Geschlecht unkorreliert
- $\chi^2=$ `r chisq.test(df_demo$gender, df_demo$age)$statistic[[1]] %>% round(., 2)`

# Lehrerfahrung

```{r}
df_demo %>% 
  ggplot(mapping = aes(x = teaching_experience)) +
  geom_histogram(binwidth = 2)
```

- Starke links-verzerrte Verteilung (zero inflation)
- 0 rausfiltern (keine Option)
- log(x + 1)

```{r}
df_demo %>% 
  ggplot(mapping = aes(x = log(teaching_experience + 1))) +
  geom_histogram(binwidth = 0.3)
```

- In jedem Fall stark korreliert mit Alter $\rightarrow$ Gefahr der Multikollinearität

```{r}
paste0("r = ", round(cor(df_demo$teaching_experience, df_demo$age), 2))
```

- Vorschlag: Lehrerfahrung weglassen und Alter aufnehmen
- Konsistent mit Idee, Expert\*innen und Noviz\*innen nicht zu trennen

## Confident Factor

```{r}
df_merge %>% 
  filter(!is.na(confident_factor)) %>% 
  group_by(event, confident_factor) %>% 
  summarize(value = n()) %>% 
  mutate(prop = value/sum(value)) %>% 
  ggplot(mapping = aes(x = reorder(event, prop),
                       y = prop,
                       fill = confident_factor
                       )
         ) +
  geom_bar(position = "stack",
           stat = "identity") +
  coord_flip() +
  scale_fill_viridis_c() +
  labs(y = "",
       x = "Event",
       fill = "Confident Factor")
```

## Disruption Factor

```{r}
df_merge %>% 
  filter(!is.na(disruption_factor)) %>% 
  group_by(event, disruption_factor) %>% 
  summarize(value = n()) %>% 
  mutate(prop = value/sum(value)) %>% 
  ggplot(mapping = aes(x = reorder(event, prop),
                       y = prop,
                       fill = disruption_factor
                       )
         ) +
  geom_bar(position = "stack",
           stat = "identity") +
  coord_flip() +
  scale_fill_viridis_c() +
  labs(y = "",
       x = "Event",
       fill = "Disruption Factor")
```

- Mittelwerte bilden? (potentielle Aussagekraft: Im Schnitt fühlten sich manche Lehrpersonen sicherer mit der Situation/fühlten sich eher gestört von der Situation)

# Erste Zusammenhänge 

## Confidence x Disruption (out of curiosity)

```{r}
df_merge %>% 
  filter(!is.na(disruption_factor) | !is.na(confident_factor)) %>% 
  ggplot(mapping = aes(x = confident_factor,
                       y = disruption_factor
                       )
         ) +
  geom_jitter(mapping = aes(color = event)) +
  geom_smooth(method = "lm",
              se = FALSE) +
  scale_color_viridis_d() +
  labs(x = "Confident Factor",
       y = "Disruption Factor",
       color = "Event")
  
```

## Alter x Confidence

```{r}
df_merge %>% 
  filter(!is.na(confident_factor) | !is.na(disruption_factor)) %>% 
  ggplot(mapping = aes(x = age,
                       y = confident_factor
                       )
         ) +
  geom_jitter(mapping = aes(color = event)) +
  geom_smooth(method = "lm")
```

- Mittelwerte:

```{r}
df_merge %>% 
  filter(!(is.na(confident_factor) | is.na(disruption_factor))) %>% 
  group_by(ID) %>% 
  summarize(mean_confident = mean(confident_factor),
            age = mean(age)) %>%
  ungroup() %>% 
  ggplot(mapping = aes(x = age,
                       y = mean_confident
                       )
         ) +
  geom_point() +
  geom_smooth(method = "lm")
```

## Alter x Disruption

```{r}
df_merge %>% 
  filter(!is.na(confident_factor) | !is.na(disruption_factor)) %>% 
  ggplot(mapping = aes(x = age,
                       y = disruption_factor
                       )
         ) +
  geom_jitter(mapping = aes(color = event)) +
  geom_smooth(method = "lm")
```

- Mittelwerte:

```{r}
df_merge %>% 
  filter(!(is.na(confident_factor) | is.na(disruption_factor))) %>% 
  group_by(ID) %>% 
  summarize(mean_disruption = mean(disruption_factor),
            age = mean(age)) %>%
  ungroup() %>% 
  ggplot(mapping = aes(x = age,
                       y = mean_disruption
                       )
         ) +
  geom_point() +
  geom_smooth(method = "lm")
```

# Heart Rate

Vorüberlegungen

- Idee: Was erklärt die zunehmende Aufregung am Anfang bzw. abnehmende Aufregung nach der Unterrichtssession?
- AV: geschätzte Lineare Steigung der Herzrate vor der Session
- Beachten: jede Person hat eigenen Ruhepuls! $\rightarrow$ random intercept, fixed slope regression model

## Pre-Phase

```{r}
main %>% 
  filter(time_span == "pre") %>% 
  select("ID","time","heart_rate") %>% 
  distinct() %>% 
  ggplot(mapping = aes(x = time,
                       y = heart_rate
                       )
         ) +
  geom_line(mapping = aes(color = as_factor(ID)),
            stat = "smooth", 
            method = "lm",
            alpha = 0.6) +
  geom_point(mapping = aes(color = as_factor(ID)),
             alpha = 0.1) +
  geom_line(stat = "smooth",
            method = "lm",
            linetype = 2) +
  labs(x = "Time (in seconds)",
       y = "Heart Rate (in beats per minute)") +
  theme(legend.position = "none",
        text = element_text(family = "serif"))
```

```{r}
main %>% 
  filter(time_span == "pre") %>% 
  select("time","ID","heart_rate","age") %>% 
  distinct() %>% 
  mutate(ID = as_factor(ID)) %>% 
  lmer(formula = heart_rate ~ (1|ID) + ID * time) %>% 
  summary() ->
  fit_first

as_tibble(fit_first$coefficients,
          rownames = "Coefficient") %>%
  filter(str_detect(.$Coefficient,
                    pattern = "time")) %>% 
  mutate(coefficient = case_when(Coefficient == "time" ~ "101",
                                 TRUE ~ Coefficient),
         ID = str_extract(string = coefficient,
                                   pattern = "[:digit:]{3}"
                                   ),
         ID = as.numeric(ID)
         ) %>% 
  select("ID","Estimate") ->
  df_estimates

df_merge %>% 
  group_by(ID) %>% 
  summarize(confident_factor_m = mean(confident_factor,
                                      na.rm = TRUE),
            disruption_factor_m = mean(disruption_factor,
                                       na.rm = TRUE),
            ID = ID,
            t_exp = teaching_experience) %>% 
  distinct() %>% 
  left_join(., df_estimates,
            by = "ID") ->
  df_corr_pre
```

```{r}
df_corr_pre %>% 
  select("ID","Estimate") %>% 
  filter(ID < 110) %>% 
  knitr::kable(., format = "simple")
```


