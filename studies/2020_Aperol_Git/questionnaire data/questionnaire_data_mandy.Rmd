---
title: "Pilot study Aperol: questionnaire data"
author: "Mandy Klatt, Gregor Kachel and Anne Deiglmayr"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

### HOW TO PREPARE DATA IN EXCEL ###
# use filter to select only lines with an ID in it 
# (i.e. exclude all empty lines or lines with na, ?, x, etc)
# select all columns except the columns for comments
# copy/paste into a new spreadsheet
# click "save as" and choose file type "tab-delimited-text"
####################################

# load tab delimited text file into R; 
# file should be in a subfolder named "data" for the script to select it
raw.data<-read.table("./data/short_questionnaire_data_1301211.txt",sep="\t", header=T) 


# loading packages
# if a package is not installed on the current machine, it will install it
if (!require(tidyverse)) install.packages('tidyverse'); library(tidyverse)

# suppress "summarize" info. 
# if this line is committed, each table using the summarize function will be accompanied with a warning from the console
options(dplyr.summarise.inform = FALSE)

### checking for missing values
apply(is.na(raw.data), 2, which)

# knock out NAs
raw.data <- raw.data  %>% filter(
  personID != "NA")


view (raw.data)
str(raw.data)

```

# Short Summary
This report provides a summary of the questionnaire data of the first pilot APEROL. The aim was to explore connections between the visual attention of the teacher and students’ in-class experience of the teachers’ "withitness". The study was conducted as a lab study with simulated scripted mini-lessons (10min per lesson). Data was collected from N = 8 teachers and N = 2 observers in 2 sessions. In each session, one subject took the role of teacher, while the other teachers acted as the class. After each lesson, the subjects answered items on classroom management, especially on the teacher's behaviour, using validated questionnaires. An external observer also answered a questionnaire. In addition, the teacher is asked to give a self-assessment on his/her classroom management. 


### Data collection
For the pilot study, we collected questionnaire data from N = `r sum(n_distinct(raw.data$personID))` subjects in `r sum(n_distinct(raw.data$session))` sessions. The questionnaires were answered after each lesson (10min) by an observer, the teacher and the other teachers acting as the class. 


The table shows the state of data collection as of `r Sys.Date()`.

```{r overview demographics data table, echo=FALSE}
raw.data %>% # select data
  group_by(session, perspective) %>%
  summarise(N = n_distinct(personID),
            "mean age" = round(mean(age), 2),
            "min age" = min(age),
            "max age" = max(age)
            ) %>% 
  knitr::kable(digits = 2)

```



### Plotting questionnaire data

```{r mean classroom management by session, echo = FALSE}

### classroom management session 1 

# filter by parameter variable, i.e. create a subset for each session
km1.data <- raw.data %>% filter(scale == "Klassenmanagement",
                               session == "1")

view (km1.data)

# value sometimes contained text before filtering, we have to convert the numbers to numeric
km1.data <- km1.data %>%  mutate(value = as.numeric(as.character(factor(value))))


# create  mean, min, max, sd of classroom management
meankm1 <- mean(km1.data$value)
minkm1 <- min(km1.data$value)
maxkm1 <- max(km1.data$value)
sdkm1 <- sd(km1.data$value)
Nkm1 <- length(unique(km1.data$personID))
mdkm1 <- median(km1.data$value)

km1.data <- raw.data %>% filter(scale == "Klassenmanagement",
                               session == "1") %>% 
  group_by(perspective, target) %>%
  summarise(N = n_distinct(personID),
            "mean age" = round(mean(age), 2),
            "min age" = min(age),
            "max age" = max(age),
            "sd age" = round(sd(age), 2),
            ) %>% 
  knitr::kable(digits = 2)

### classroom management session 2 

# filter by parameter variable, i.e. create a subset for each session
km2.data <- raw.data %>% filter(scale == "Klassenmanagement",
                               session == "2")

view (km2.data)

# value sometimes contained text before filtering, we have to convert the numbers to numeric
km2.data <- km2.data %>%  mutate(value = as.numeric(as.character(factor(value))))


# create  mean, min, max, sd of classroom management
meankm2 <- mean(km2.data$value)
minkm2 <- min(km2.data$value)
maxkm2 <- max(km2.data$value)
sdkm2 <- sd(km2.data$value)
Nkm2<-length(unique(km2.data$personID))

```

The item "classroom management"  was rated by the observer, the teacher and students on average in session 1 with `r round(meankm1, 2)` (min = `r minkm1`; max = `r maxkm1`; SD = `r round(sdkm1,2)`; N = `r Nkm1`; lickert-scale 1-4; 4 = best evaluation) and in session 2 with `r round(meankm2, 2)` (min = `r minkm2`; max = `r maxkm2`; SD = `r round(sdkm2,2)`; N = `r Nkm2`; lickert-scale 1-4; 4 = best evaluation).


```{r Modul horicontal Plots,  fig.height = 4, message = FALSE, warning = FALSE , echo=FALSE}

# to create error bars, we need to summarise the data in a seperate dataframe
modul.plot.sd <-modul.plot.data %>%
  group_by(itemfulltext, Teilnehmende, .drop=TRUE) %>%
  summarise(mean = mean(value), n = n(), sd = sd(value), se = sd/sqrt(n), )

# and here comes the long plot
modul.plot<-ggplot(data = modul.plot.sd,
                           aes(x = itemfulltext, y = mean,
                               group=Teilnehmende, colour = Teilnehmende)) +
  geom_line()+
  geom_pointrange(position = position_dodge(0.1), aes(ymin = mean-se, ymax = mean+se))+
  theme_light() +
  ylim(1,5)+
  labs(data = modul.plot.data, y = "Ausprägung", x = NULL,
       title="Modulbewertung" ,
       subtitle=NULL)+
  theme(legend.position="bottom",
        panel.spacing.x = ,
        plot.title = element_text(hjust = 0.5))+
  scale_x_discrete(labels = function(x) str_wrap(x, width = 55))+
  coord_flip()
modul.plot

```


### Comparing Performance across age-groups and conditions
We used Wilcoxon/Mann-Whitney-U-tests to test for significant differences in children's performance across age-groups and conditions respectively. 

xxx To Do xxx

### Full Analysis (GLMM, ANOVA)
We are going to analyze our outcome (correct choice 0/1) in a 2x2 design (condition (comm, noncomm); age (3yo, 4yo) using either a GLMM or ANOVA depending on prior tests on data structure and model stability. 

xxx To Do xxx

# References

R Core Team (2019). R: A language and environment for statistical computing. R Foundation for Statistical Computing, Vienna, Austria. URL https://www.R-project.org/.

Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686


